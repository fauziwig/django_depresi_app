{% extends "base.html" %}
{% load static %}
{% block title %}Akun Pengguna - DepresiCare{% endblock %}

{% block content %}
<div class="container py-5" style="min-height:80vh;">
    <h1 class="text-center mb-5" style="font-weight:700;font-size:2.5rem;">
        Akun <span style="color:#C084FC;">Pengguna</span>
    </h1>
    <div class="text-center mb-5">
        <a href="{% url 'logout_url' %}" class="btn btn-sm text-danger" style="background:#f3e8ff; border:1px solid #C084FC;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="mb-4">
                <div class="fw-semibold mb-2" style="font-size:1.15rem;">Informasi Pengguna</div>
                <div class="mb-3">
                    <label class="form-label">Nama</label>
                    <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" value="{{ user.username }}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="text" class="form-control" value="{{ user.email }}" readonly>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="fw-semibold mb-2" style="font-size:1.15rem;">
                {% if user_is_admin_or_expert %}
                    Riwayat Seluruh Diagnosis
                {% else %}
                    Riwayat Diagnosis Anda
                {% endif %}
            </div>
            {% if diagnosis_history %}
                {% for diag in diagnosis_history %}
                <div class="border rounded mb-4 p-3" style="background:#fff7f7; border:1.5px solid #9e7a7a;">
                    <div class="fw-semibold" style="font-size:1.15rem; margin-bottom:0.5rem;">
                        Diagnosis pada {{ diag.submitted_at|date:"j F Y, H:i" }}
                        {% if user_is_admin_or_expert %}
                            <br>
                            <small class="text-muted" style="font-size: 0.85rem;">Oleh: {{ diag.user.username|default:"Pengguna Tamu" }}</small>
                        {% endif %}
                    </div>
                    <div class="mb-2" style="font-size:1rem;">
                        {{ diag.result_text|safe }}
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm detail-toggle-btn" style="background:#C084FC;color:#fff;min-width:110px;" type="button" data-diag-id="{{ diag.id }}">
                            Lihat Detail
                        </button>
                        {% if user.is_superuser or user.is_staff %}
                            <form method="post" action="{% url 'expert_reuse_data' diag.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button class="btn btn-sm ms-2" style="background:#f3e8ff;color:#7c3aed;min-width:150px;">Tambah ke Dataset</button>
                            </form>
                        {% endif %}
                    </div>
                    <div class="detail-riwayat mt-4" id="detail-riwayat-{{ diag.id }}" style="display:none;">
                        <div class="fw-semibold mb-2" style="font-size:1.1rem;">Detail Riwayat Diagnosis</div>
                        <div class="table-responsive">
                            <table class="table table-bordered" style="background:#f8e6f8;">
                                <thead style="background:#b46fc2;color:#fff;">
                                    <tr>
                                        <th>Pertanyaan</th>
                                        <th>Jawaban</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in diag.data_summary %}
                                        <tr>
                                            <td>{{ item.label }}</td>
                                            <td>{{ item.value }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm tutup-detail-btn mt-2" style="background:#C084FC;color:#fff;">Tutup Detail</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-muted">Belum ada riwayat diagnosis.</div>
            {% endif %}
        </div>
    </div>

    <div class="mb-4">
        <div class="p-3 rounded" style="background:#FFEB3B; border:1px solid #E0C200;">
            <strong>Catatan Penting</strong>
            <p class="mb-0 mt-2" style="font-size:1rem;">
                Alat ini tidak dapat menggantikan konsultasi langsung dengan profesional kesehatan mental (psikolog atau psikiater). Jika Anda merasa khawatir tentang kesehatan mental atau jiwa, jangan ragu untuk mencari dukungan dari profesional.<br>
                Mengambil langkah selanjutnya untuk <strong>berkonsultasi dengan profesional</strong> adalah tindakan yang bijaksana untuk merawat diri. Berikut adalah beberapa fasilitas kesehatan di Yogyakarta yang memiliki layanan psikologi dan psikiatri (kesehatan jiwa) yang terpercaya:
            </p>
        </div>
    </div>

    <div class="card border-dark mb-4" style="border-radius:16px;">
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-4 d-flex align-items-start">
                    <img src="{% static 'rssardjito.webp' %}" alt="RSUP Dr Sardjito" class="rounded" style="width:100px;height:100px;object-fit:cover;">
                    <div class="ms-3">
                        <div class="fw-bold" style="font-size:1.1rem;">RSUP Dr Sardjito</div>
                        <div style="font-size:0.85rem; font-style:italic; color:#555;">
                            Jl. Kesehatan, Jl. Kesehatan Sendowo No.1, Sendowo, Sinduadi, Kec. Mlati, Kabupaten Sleman, Daerah Istimewa Yogyakarta 55281
                        </div>
                        <div class="mt-2" style="font-size:0.97rem;">
                            <span class="d-block mb-1" style="color:#673968;"><strong>Telp:</strong> (0274) 587333</span>
                            <a href="https://sardjito.co.id/" target="_blank" style="color:#7c3aed; word-break:break-all; font-size:0.97rem;">https://sardjito.co.id/</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-start">
                    <img src="{% static 'rsgrhasia.jpg' %}" alt="RSJ Grhasia" class="rounded" style="width:100px;height:100px;object-fit:cover;">
                    <div class="ms-3">
                        <div class="fw-bold" style="font-size:1.1rem;">RSJ Grhasia</div>
                        <div style="font-size:0.85rem; font-style:italic; color:#555;">
                            Jl. Kaliurang KM 17, Pakem, Sleman, Daerah Istimewa Yogyakarta 55582
                        </div>
                        <div class="mt-2" style="font-size:0.97rem;">
                            <span class="d-block mb-1" style="color:#673968;"><strong>Telp:</strong> (0274) 895070</span>
                            <a href="https://rsjgrhasia.jogjaprov.go.id/" target="_blank" style="color:#7c3aed; word-break:break-all; font-size:0.97rem;">https://rsjgrhasia.jogjaprov.go.id/</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-start">
                    <img src="{% static 'rspantirapih.jpeg' %}" alt="RS Panti Rapih" class="rounded" style="width:100px;height:100px;object-fit:cover;">
                    <div class="ms-3">
                        <div class="fw-bold" style="font-size:1.1rem;">RS Panti Rapih</div>
                        <div style="font-size:0.85rem; font-style:italic; color:#555;">
                            Jl. Cik Di Tiro No.30, Terban, Kec. Gondokusuman, Kota Yogyakarta, Daerah Istimewa Yogyakarta 55223
                        </div>
                        <div class="mt-2" style="font-size:0.97rem;">
                            <span class="d-block mb-1" style="color:#673968;"><strong>Telp:</strong> (0274) 563333</span>
                            <a href="https://pantirapih.or.id/" target="_blank" style="color:#7c3aed; word-break:break-all; font-size:0.97rem;">https://pantirapih.or.id/</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Toggle detail riwayat
    document.querySelectorAll('.detail-toggle-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var diagId = btn.getAttribute('data-diag-id');
            var detailDiv = document.getElementById('detail-riwayat-' + diagId);
            if (detailDiv) {
                detailDiv.style.display = 'block';
                btn.style.display = 'none';
            }
        });
    });
    // Tutup detail
    document.querySelectorAll('.tutup-detail-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var detailDiv = btn.closest('.detail-riwayat');
            if (detailDiv) {
                detailDiv.style.display = 'none';
                // Show the corresponding "Lihat Detail" button again
                var parent = detailDiv.parentElement;
                var lihatBtn = parent.querySelector('.detail-toggle-btn');
                if (lihatBtn) {
                    lihatBtn.style.display = 'inline-block';
                }
            }
        });
    });
});
</script>
{% endblock %}